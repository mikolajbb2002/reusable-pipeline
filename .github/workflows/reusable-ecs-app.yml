name: Reusable Terraform

on:
  workflow_call:
    inputs:
      tf_workdir:
        description: "Folder with Terraform configuration"
        required: true
        type: string
      terraform_version:
        description: "Terraform version to use"
        required: false
        type: string
        default: "1.9.5"
      aws_region:
        required: true
        type: string
      auto_apply:
        description: "If true, applies the Terraform plan automatically (skipped for PRs)"
        required: false
        type: boolean
        default: false
      ecr_repository_name:
        required: false
        type: string
      ecr_image_tag:
        required: false
        type: string
      ecs_cluster_name:
        required: false
        type: string
    secrets:
      aws_plan_role_arn:
        description: "OIDC: role for planning"
        required: true
      aws_apply_role_arn:
        description: "OIDC: role for apply"
        required: true
      token:
        description: "GITHUB_TOKEN for checkout action"
        required: true

permissions:
  id-token: write
  contents: read

concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: false

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      TF_WORKDIR: ${{ inputs.tf_workdir }}
      AWS_REGION: ${{ inputs.aws_region }}
      TF_VAR_region: ${{ inputs.aws_region }}
      ECR_REPOSITORY_NAME: ${{ inputs.ecr_repository_name }}
      ECR_IMAGE_TAG: ${{ inputs.ecr_image_tag }}
      ECS_CLUSTER_NAME: ${{ inputs.ecs_cluster_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.token }}
      - name: Pick role ARN
        id: pick
        run: |
          if [ "${{ inputs.auto_apply }}" = "true" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "role=${{ secrets.AWS_TERRAFORM_APPLY_ROLE_ARN }}" >> $GITHUB_OUTPUT
          else
            echo "role=${{ secrets.AWS_TERRAFORM_PLAN_ROLE_ARN }}" >> $GITHUB_OUTPUT
          fi
      - name: Validate role ARN is present
        run: |
          if [ -z "${{ secrets.aws_role_arn }}" ]; then
          echo "Missing secret 'aws_role_arn'. Ensure caller passes a non-empty ARN (e.g., secrets.AWS_ROLE_TO_ASSUME)." >&2
          exit 1
          fi
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.aws_role_arn }}
          aws-region: ${{ inputs.aws_region }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKDIR }}
        run: terraform init -input=false

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKDIR }}
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKDIR }}
        run: terraform plan -input=false -out=tfplan

      - name: Terraform Apply (optional)
        if: ${{ inputs.auto_apply && github.event_name != 'pull_request' }}
        working-directory: ${{ env.TF_WORKDIR }}
        run: terraform apply -input=false -auto-approve tfplan